<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <style>
        *{box-sizing:border-box;
            font-family:'SBAggro';
        }

        .content {
            padding: 30px 25px;
        }

        .title {
            margin: 10px 10px 20px;
            font-size: 40px;
            font-weight: 700;
            font-family: 'SBAggro';
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            color: #2f1a48;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input, select {
            padding: 10px 12px;
            border: 1px solid rgba(0,0,0,.25);
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        .input:focus, select:focus {
            border-color: rgba(0,0,0,.5);
            box-shadow: 0 0 0 3px rgba(138, 78, 191, 0.2);
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-row .input {
            flex: 1;
        }

        .check-btn {
            height: 36px;
            padding: 0 14px;
            border: 1px solid rgba(0,0,0,.25);
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
        }

        .hint {
            font-size: 12px;
            color: #666;
        }

        .actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
        }

        #nextBtn {
            height: 30px;
            padding: 0 16px;
            border: 1px solid rgba(0,0,0,.25);
            border-radius: 8px;
            background: #ffffff;
            color: #000000;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
        }
        .deleteback{
            width:100%;
            height:100%;
            background: rgba(0,0,0,50%);
            z-index:1100;
            display:none;
            position:fixed;
            top:0;
            left:0;
        }
        .viewdeleteback{
            width:100%;
            height:100%;
            background: rgba(0,0,0,50%);
            z-index:1100;
            display:flex;
            position:fixed;
            top:0;
            left:0;
            align-items:center;
            justify-content:center;
        }
        #deletemodal{
            width:25%;
            height:30%;
            background:#fff;
            position:fixed;
            top:35%;
            left:37.5%;
            z-index:1004;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            border-radius:8px;
            padding:20px;
            box-shadow:0 8px 20px rgba(0,0,0,.25);
        }
        #deletemodal p{
            font-size:16px;
            font-weight:700;
            margin-bottom:18px;
            text-align:center;
        }
        #deletemodal button{
            min-width:80px; height:32px; border:1px solid rgba(0,0,0,.25);
            border-radius:8px; background:#fff; cursor:pointer;
        }
    </style>
</head>
<body>

<div th:include="/common/header.html"></div>
<div id="main">
    <div class="content">
        <p class="title">회원가입</p>

        <form id="registerForm" th:action="@{/member/register}" method="post" th:object="${member}">
            <!-- 아이디 -->
            <div class="field">
                <label for="memberId">아이디</label>
                <div class="input-row">
                    <input type="text" name="memberId" id="memberId"
                           pattern="^(?=.{4,20}$)(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$"
                           title="아이디는 영문과 숫자를 모두 포함한 4~20자여야 합니다."
                           required autocomplete="off"
                           oninput="this.value=this.value.replace(/[^A-Za-z0-9]/g,'');">
                            <!-- required minlength="4" : 4글자 이상 -->
                    <button class="check-btn" type="button" id="checkIdBtn">중복확인</button>
                </div>
                <span id="idMsg" class="hint"></span>
            </div>

            <!-- 비밀번호 -->
            <div class="field">
                <label for="memberPwd">비밀번호</label>
                <input class="input" type="password" th:field="*{memberPwd}" id="memberPwd"
                       required minlength="8" maxlength="30" autocomplete="new-password"/>
                <p class="hint">* 영문/숫자 포함 8자 이상</p>
            </div>

            <!-- 비밀번호 확인 -->
            <div class="field">
                <label for="pwdConfirm">비밀번호 확인</label>
                <input class="input" type="password" id="pwdConfirm" name="confirmPwd"
                       required minlength="8" maxlength="30" autocomplete="new-password"/>
                <!-- 비밀번호 일치/불일치 메시지 표시 -->
                <span id="pwdMsg" class="hint"></span>
            </div>

            <!-- 이메일 -->
            <div class="field">
                <label for="email">이메일</label>
                <input class="input" type="email" th:field="*{email}" id="email" required/>
            </div>

            <!-- 이름 -->
            <div class="field">
                <label for="memberName">이름</label>
                <input class="input" type="text" th:field="*{memberName}" id="memberName" required/>
            </div>

            <!-- 생년월일 -->
            <div class="field">
                <label for="memberBdate">생년월일</label>
                <input class="input" type="date" th:field="*{memberBdate}" id="memberBdate" required/>
            </div>

            <!-- 성별 -->
            <div class="field">
                <label for="memberGender">성별</label>
                <select class="input" th:field="*{memberGender}" id="memberGender" required>
                    <option value="M">남자</option>
                    <option value="F">여자</option>
                </select>
            </div>

            <div class="actions">
                <button id="nextBtn" type="submit" disabled>회원가입</button>
            </div>
        </form>
    </div>
</div>
<!-- 회원가입 완료 모달 -->
<div class="deleteback" id="registerModalBack">
    <div id="deletemodal">
        <p id="registerModalMsg">회원가입이 완료되었습니다!</p>
        <button id="registerOkBtn">확인</button>
    </div>
</div>

<script>
    const $form = document.getElementById('registerForm');
    const $submit = document.getElementById('nextBtn');

    const $id = document.getElementById('memberId');
    const $checkBtn = document.getElementById('checkIdBtn');
    const $idMsg = document.getElementById('idMsg');

    const $pwd = document.getElementById('memberPwd');
    const $pwd2 = document.getElementById('pwdConfirm');
    const $pwdMsg = document.getElementById('pwdMsg');

    let idAvailable = false;

    // 아이디 중복확인
    $checkBtn.addEventListener('click', async () => {
        const memberId = $id.value.trim();
        if (memberId.length < 4) {
            setIdMsg('아이디는 4자 이상 입력하세요.', false);
            idAvailable = false;
            updateSubmit();
            return;
        }
        try {
            const res = await fetch(`/member/register/check-id?memberId=${encodeURIComponent(memberId)}`);
            const data = await res.json();
            idAvailable = !!data.available;
            setIdMsg(idAvailable ? '사용 가능한 아이디입니다.' : '이미 사용 중인 아이디입니다.', idAvailable);
        } catch {
            setIdMsg('중복확인 API 오류', false);
            idAvailable = false;
        } finally {
            updateSubmit();
        }
    });

    $id.addEventListener('input', () => {
        idAvailable = false;
        $idMsg.textContent = '중복확인을 해주세요.';
        $idMsg.style.color = '#a30000';
        updateSubmit();
    });

    // 비밀번호 일치 실시간 체크
    function pwdOK() {
        const ok = $pwd.value.length >= 8 && $pwd.value === $pwd2.value;
        if ($pwd.value === '' && $pwd2.value === '') {
            $pwdMsg.textContent = '';
        } else {
            $pwdMsg.textContent = ok ? '비밀번호가 일치합니다.' : '비밀번호가 일치하지 않습니다.';
            $pwdMsg.style.color = ok ? '#000000' : '#a30000';
        }
        return ok;
    }
    $pwd.addEventListener('input', () => { pwdOK(); updateSubmit(); });
    $pwd2.addEventListener('input', () => { pwdOK(); updateSubmit(); });

    // 바로 다음으로 넘어가지 못하게
    $form.addEventListener('submit', (e) => {
        if (!idAvailable || !pwdOK()) {
            e.preventDefault();
            if (!idAvailable) setIdMsg('아이디 중복확인을 완료하세요.', false);
        }
    });

    function setIdMsg(text, ok) {
        $idMsg.textContent = text;
        $idMsg.style.color = ok ? '#000000' : '#a30000';
    }
    function updateSubmit() {
        $submit.disabled = !(idAvailable && pwdOK());
    }
</script>
<script>
    (function () {
        const form   = document.getElementById('registerForm');
        const btn    = document.getElementById('nextBtn');

        const back   = document.getElementById('registerModalBack');
        const msgEl  = document.getElementById('registerModalMsg');
        const okBtn  = document.getElementById('registerOkBtn');

        function openModal(message, onOk){
            if (message) msgEl.textContent = message;
            back.className = 'viewdeleteback';
            okBtn.onclick = function(){
                back.className = 'deleteback';
                if (onOk) onOk();
            };
        }

        form.addEventListener('submit', async function(e){
            // 기존 유효성(아이디 중복/비번일치)이 통과했을 때만 진행
            if (btn.disabled) { e.preventDefault(); return; }

            e.preventDefault();                       // 기본 submit 막기
            const action = form.getAttribute('action') || form.action;
            const fd = new FormData(form);

            // CSRF가 켜져 있으면 히든 필드에서 토큰 읽어 헤더로 보냄(지금은 꺼져있음 자동 스킵)
            const csrfInput = form.querySelector('input[name="_csrf"]');
            const headers = csrfInput ? { 'X-CSRF-TOKEN': csrfInput.value } : {};

            try {
                const resp = await fetch(action, { method:'POST', body: fd, headers });
                if (!resp.ok) {
                    openModal('회원가입에 실패했습니다. 잠시 후 다시 시도해 주세요.');
                    return;
                }
                // 성공: 모달 → 확인 → 로그인 페이지로 이동
                openModal('회원가입이 완료되었습니다!', () => location.href = '/member/login');

            } catch (err) {
                openModal('네트워크 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.');
            }
        });
    })();
</script>
</body>
</html>